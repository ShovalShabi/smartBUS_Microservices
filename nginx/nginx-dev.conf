worker_processes 1;

events {
    worker_connections 1024;
}

http {
    include       mime.types;
    default_type  application/octet-stream;

    # WebSocket support
    map $http_upgrade $connection_upgrade {
        default upgrade;
        ''      close;
    }

    # Define upstream for services (dev environment)
    upstream auth_backend {
        server auth-dev:3804;
    }

    upstream feedback_backend {
        server feedback-dev:5003;
    }

    upstream orderbus_backend {
        server orderbus-dev:6936;
    }

    upstream routes_backend {
        server routes-dev:6924;
    }

    server {
        listen 8080;  # Listen on all network interfaces
        server_name localhost 192.168.1.186 _;
        http2 on;

        # Optional: Restrict access to LAN devices only (modify according to your LAN range)
#         allow 192.168.1.0/24;

        # Proxy settings for backend services
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection $connection_upgrade;
        proxy_cache_bypass $http_upgrade;

        # Enable DNS resolution for dynamic proxies
        resolver 8.8.8.8 8.8.4.4 valid=300s;
        resolver_timeout 10s;


        # Route to Auth Service (Dev) with /auth-service prefix
        location /auth-service/ {
            rewrite ^/auth-service/(.*)$ /$1 break;  # Strip prefix and pass to backend
            proxy_pass http://auth_backend;
        }

        # Route to Feedback Service (Dev) with /feedback-service prefix
        location /feedback-service/ {
            rewrite ^/feedback-service/(.*)$ /$1 break;
            proxy_pass http://feedback_backend;
        }

        # Route to OrderBus Service (Dev) with /orderbus-service prefix
        location /orderbus-service/ {
            rewrite ^/orderbus-service/(.*)$ /$1 break;
            proxy_pass http://orderbus_backend;
        }

        # Route to Routes Service (Dev) with /routes-service prefix
        location /routes-service/ {
            rewrite ^/routes-service/(.*)$ /$1 break;
            proxy_pass http://routes_backend;
        }

        # WebSocket endpoint for OrderBus Service
        location /ws/ {
            proxy_pass http://orderbus_backend;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
            proxy_http_version 1.1;
            proxy_set_header Host $host;
            proxy_cache_bypass $http_upgrade;
        }
    }
}
